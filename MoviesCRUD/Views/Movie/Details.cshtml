@model MoviesCRUD.Models.ViewModel.MovieDetailsVM
﻿@using MoviesCRUD.Models.ViewModel;
@using Microsoft.AspNetCore.Identity;
@inject UserManager<IdentityUser> userManager;

@{
    ViewData["Title"] = "Details";
}


<div>
    <h4>Movie</h4>
    <hr />
    <dl class="row">
        <div class="d-flex justify-content-center row">
        <dd class="col-sm-12">
            @*@Html.DisplayFor(model => model.ImagePath)*@
            <img src="~/@Model.Movie.ImagePath" alt="Movie Image" class="img-fluid" width="200px" height="200px" />
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Movie.MovieName)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Movie.MovieName)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Movie.MovieDescription)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Movie.MovieDescription)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Movie.MovieGenre)
        </dt>
        <dd class = "col-sm-10">
            @Html.DisplayFor(model => model.Movie.MovieGenre)
        </dd>
        <dt class = "col-sm-2">
            @Html.DisplayNameFor(model => model.Movie.AverageRating)
        </dt>
        <dd name="refresh" class = "col-sm-10">
            @Html.DisplayFor(model => model.Movie.AverageRating)
        </dd>
    </dl>
</div>

<div>
    <a asp-action="Update" asp-route-id="@Model?.Movie.MovieId">Edit</a> |
    <a asp-action="UpdateImage" asp-route-id="@Model?.Movie.MovieId">Change Image</a> |
    <a asp-action="Index">Back to List</a>
</div>
<div name="refresh">
@if (User.Identity.IsAuthenticated)
{
    @if (!ViewBag.HasRated)
    {
        <partial name="../Rating/_AddRating" model="@Model.Movie.MovieId" />
    }
    @if (ViewBag.HasRated)
    {
        <h4>You have rated: @ViewBag.UserRating</h4>
    }
}
</div>
<hr />
<h2>Comment Section</h2>

@if (User.Identity.IsAuthenticated)
{
    <partial name="../Comment/_AddComment" model="@Model.Movie.MovieId" />

}
else
{
    <h4 class="text-info">Login In to comment!</h4>
}

<div id="commentList">
    <partial name="../Comment/_ViewComment" model="@Model.Comments" />
</div>
@section Scripts{
    <script>
            function AddComment() {
                var movieId = $('#MovieId').val();
                var text = $('#commentBox').val();
                $('#commentBox').val('');

                $.ajax({
                    url: '@Url.Action("AddComment", "Comment")',
                    type: 'POST',
                    data: { MovieId: movieId, Text: text },
                    success: function (result) {
                       $('#commentList').html(result);
                       console.log(result);
                    },
                    error: function (xhr, status, error) {
                        console.log(error);
                    }
                });
            }
        $(document).ready(function () {
            $('#AddComment').submit(function (event) {
                event.preventDefault();
                var commentText = $('#commentBox').val().trim();
                if (commentText === '') {
                    $('#commentValidation').text('Please enter a comment.');
                    return false;
                }
                AddComment();

            });
        });
     
        $(document).ready(function () {
            $('input[type="radio"]').click(function () {
                $('#submitRating').show();
            });
        });
        $(document).ready(function () {
            $('#ratingSubmit').click(function (event) {
                event.preventDefault();

                var rating = $('input[name="rating"]:checked').val();
                $('#ratingValue').text(rating);
                var movieId = $('input[name="MovieId"]').val();
                var data = {
                    Value: rating,
                    MovieId: movieId
                };
                $.ajax({
                    url: '@Url.Action("AddRating", "Rating")',
                    type: 'POST',
                    data: data,
                    success: function (response) {
                        // Handle the success response
                        $('#RatingForm').hide();
                        location.reload();
                        //$('[name="refresh"]').load(location.href + '[name="refresh"]');
                        
                    },
                    error: function (xhr, status, error) {
                        // Handle the error response
                        console.log(error);
                    }
                });
            });
        });
    </script>
    }